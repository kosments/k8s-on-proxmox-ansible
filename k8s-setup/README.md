# Kubernetes Cluster Setup

ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€ProxmoxVMä¸Šã«Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹ãŸã‚ã®2ã¤ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

## ğŸš€ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1: ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ¨å¥¨ï¼‰

### ç‰¹å¾´
- ã‚·ãƒ³ãƒ—ãƒ«ã§ç†è§£ã—ã‚„ã™ã„
- ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“
- SSHæ¥ç¶šã‚’1ã¤ãšã¤å‡¦ç†
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå……å®Ÿ

### ä½¿ç”¨æ–¹æ³•

```bash
# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸
chmod +x setup-k8s-cluster.sh

# ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ä½œæˆå®Ÿè¡Œ
./setup-k8s-cluster.sh
```

### è¨­å®šé …ç›®
ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã®ä»¥ä¸‹ã®å¤‰æ•°ã‚’ç’°å¢ƒã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ï¼š

```bash
MASTER_IP="192.168.10.101"
NODE1_IP="192.168.10.102"  
NODE2_IP="192.168.10.103"
SSH_USER="ubuntu"
SSH_KEY="~/.ssh/id_rsa"
K8S_VERSION="1.28.2-1.1"
POD_CIDR="10.244.0.0/16"
```

## ğŸ¯ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2: ã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ£ãƒ«Ansible

### ç‰¹å¾´
- å„ãƒãƒ¼ãƒ‰ã‚’é †ç•ªã«è¨­å®š
- SSHæ¥ç¶šã®ç«¶åˆã‚’å›é¿
- Ansibleã®å†ªç­‰æ€§ã‚’æ´»ç”¨
- ã‚ˆã‚Šè©³ç´°ãªåˆ¶å¾¡ãŒå¯èƒ½

### ä½¿ç”¨æ–¹æ³•

```bash
# ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªãƒ»èª¿æ•´
vim inventory.ini

# ãƒ—ãƒ¬ã‚¤ãƒ–ãƒƒã‚¯å®Ÿè¡Œ
ansible-playbook -i inventory.ini sequential-playbook.yml
```

## ğŸ“‹ å‰ææ¡ä»¶

1. **SSHæ¥ç¶šã®è¨­å®š**
   - ã™ã¹ã¦ã®VMã«SSHéµèªè¨¼ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
   - `~/.ssh/id_rsa`ã«ç§˜å¯†éµãŒé…ç½®æ¸ˆã¿

2. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š**
   - ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰ãŒç›¸äº’é€šä¿¡å¯èƒ½
   - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒåˆ©ç”¨å¯èƒ½

3. **ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶**
   - Ubuntu 22.04 LTS
   - æœ€ä½2GB RAMã€2CPU
   - ã‚¹ãƒ¯ãƒƒãƒ—ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨

## ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 1. VMä½œæˆï¼ˆäº‹å‰ã«å®Œäº†ï¼‰
```bash
cd ../proxmox-vm-setup
ansible-playbook -i inventory.ini playbook.yml
```

### 2. Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹ç¯‰
```bash
# æ–¹æ³•A: ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
./setup-k8s-cluster.sh

# æ–¹æ³•B: Ansibleãƒ—ãƒ¬ã‚¤ãƒ–ãƒƒã‚¯  
ansible-playbook -i inventory.ini sequential-playbook.yml
```

### 3. ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ç¢ºèª
```bash
# kubeconfigã‚’è¨­å®š
export KUBECONFIG=$PWD/kubeconfig

# ãƒãƒ¼ãƒ‰çŠ¶æ…‹ç¢ºèª
kubectl get nodes

# PodçŠ¶æ…‹ç¢ºèª
kubectl get pods -A
```

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### SSHæ¥ç¶šã‚¨ãƒ©ãƒ¼
```bash
# SSHæ¥ç¶šãƒ†ã‚¹ãƒˆ
ssh -o ConnectTimeout=10 -i ~/.ssh/id_rsa ubuntu@192.168.10.101

# SSH Agentç¢ºèª
ssh-add -l
```

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å•é¡Œ
```bash
# CNI PodçŠ¶æ…‹ç¢ºèª
kubectl get pods -n kube-flannel

# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šç¢ºèª
kubectl get nodes -o wide
```

### ãƒ­ã‚°ç¢ºèª
```bash
# kubelet ãƒ­ã‚°
sudo journalctl -u kubelet -f

# containerd ãƒ­ã‚°
sudo journalctl -u containerd -f
```

## ğŸ“Š æ§‹æˆæƒ…å ±

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | èª¬æ˜ |
|---------------|------------|------|
| Kubernetes | 1.28.2 | ãƒ¡ã‚¤ãƒ³ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ |
| containerd | latest | ã‚³ãƒ³ãƒ†ãƒŠãƒ©ãƒ³ã‚¿ã‚¤ãƒ  |
| Flannel | latest | CNIï¼ˆContainer Network Interfaceï¼‰ |
| Ubuntu | 22.04 LTS | ãƒ™ãƒ¼ã‚¹OS |

## ğŸ‰ å®Œäº†å¾Œã®ç¢ºèª

ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹ç¯‰å®Œäº†å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

```bash
# ãƒãƒ¼ãƒ‰çŠ¶æ…‹ï¼ˆã™ã¹ã¦Readyã«ãªã£ã¦ã„ã‚‹ï¼‰
kubectl get nodes

# ã‚·ã‚¹ãƒ†ãƒ Podï¼ˆã™ã¹ã¦Runningã«ãªã£ã¦ã„ã‚‹ï¼‰
kubectl get pods -n kube-system

# Flannel Podï¼ˆå„ãƒãƒ¼ãƒ‰ã§1ã¤ãšã¤Runningï¼‰
kubectl get pods -n kube-flannel
```

æ­£å¸¸ã«å®Œäº†ã™ã‚‹ã¨ã€3ãƒãƒ¼ãƒ‰ã®Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
